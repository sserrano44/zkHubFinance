# Hubris V2 Production Readiness Plan

This plan closes the remaining gaps between the current MVP and production deployment on Base (hub) + Worldchain (spoke).

## Exit Criteria

Production-ready means all items below are true:

1. Settlement uses real zero-knowledge proofs generated by the prover service and verified on-chain.
2. Supply/repay crediting is backed by canonical bridge attestations, not relayer/operator mint simulation.
3. Internal service APIs are authenticated and not publicly writable.
4. Relayer, indexer, and prover state is durable, idempotent, and reorg-safe.
5. Contracts and services have completed external security review and critical findings are resolved.
6. CI/CD and runbooks support repeatable testnet and mainnet release with rollback procedures.

---

## Phase 0 (Blockers)

### P0-1 Real ZK proving pipeline

Status: In progress (real proof plumbing implemented; full production constraints still pending).

Current blockers:
- Settlement correctness circuit still needs full lock/fill/deposit validity constraints.
- Generated verifier from final audited circuit not yet deployed in production envs.

Deliverables:
1. Replace scaffold circuit with real constraints:
   - Include/validate deposit commitments from spoke.
   - Include/validate lock + fill matching for borrow/withdraw.
   - Enforce amount/fee consistency against public inputs.
2. Generate proving and verification keys.
3. Deploy generated Solidity verifier contract.
4. Wire `CircuitProofProvider` to witness generation + proof generation.
5. Run `Verifier` with `DEV_MODE=false` and non-zero verifier contract.

Implemented:
1. `CircuitProofProvider` now executes `snarkjs groth16 fullprove` and ABI-encodes Groth16 proofs for on-chain submission.
2. `circom/SettlementBatchRoot.circom` replaced with a concrete deterministic action-root circuit.
3. Added `Groth16VerifierAdapter` contract to bridge generic `(bytes proof, uint256[] publicInputs)` into generated verifier signature.
4. Settlement action root is now SNARK-field-safe and deterministic across hub + prover.
5. Added artifact build script: `circuits/prover/build-artifacts.sh`.
6. Added production-verifier settlement tests that reject tampered proofs and accept valid proofs.
7. Deployment script supports `HUB_VERIFIER_DEV_MODE=0` + `HUB_GROTH16_VERIFIER_ADDRESS` to deploy prod verifier wiring.
8. Added dedicated circuit-mode fork E2E runner: `scripts/e2e-fork-circuit.mjs`.
9. Added circuit E2E prepare helper that auto-deploys generated verifier and prints required env exports: `scripts/e2e-fork-circuit-prepare.mjs`.

Acceptance criteria:
1. `PROVER_MODE=circuit` succeeds end-to-end without fallback to dev proof.
2. Settlement fails if proof/public inputs are tampered.
3. On-chain verification succeeds for valid batches and rejects invalid batches.
4. Batch size 50 can be proven and settled within defined SLO.

---

### P0-2 Canonical bridge attestation path for deposits

Status: Not production-safe yet.

Current blockers:
- Relayer still mints hub assets in simulation path:
  - `/services/relayer/src/server.ts`
- Custody trust currently depends on `BRIDGE_ROLE` operator registration:
  - `/contracts/src/hub/HubCustody.sol`

Deliverables:
1. Implement canonical bridge event ingestion in relayer/indexer:
   - Track spoke bridge send tx + hub bridge receive tx.
   - Persist source tx hash + log index + finality height.
2. Modify custody ingestion so deposits are accepted only from canonical bridge receiver path.
3. Add anti-replay keying over `(originChainId, originTxHash, originLogIndex, depositId)`.
4. Remove operator mint simulation from production runtime path.

Acceptance criteria:
1. A deposit cannot be credited unless canonical receive is observed/finalized.
2. Replay of same bridge event is rejected.
3. Relayer cannot mint/credit assets outside canonical bridge flow.

---

### P0-3 Internal API authentication and network hardening

Status: In progress (core auth + replay protection implemented).

Current blockers:
- Prover and indexer internal endpoints are unauthenticated:
  - `/services/prover/src/server.ts`
  - `/services/indexer/src/server.ts`

Deliverables:
1. Add service-to-service auth for internal routes:
   - HMAC signing or JWT with short TTL and audience checks.
2. Restrict CORS to trusted origins and private network ingress.
3. Add per-route rate limiting and payload size limits.
4. Add request-id tracing and structured audit logs for privileged actions.

Implemented:
1. HMAC-signed internal request validation added on `indexer` and `prover` for `/internal/*`.
2. Timestamp skew checks + replay cache protection added.
3. `relayer` and `prover` internal calls now sign requests.
4. CORS origin is now configurable via `CORS_ALLOW_ORIGIN` env.
5. API and internal-route rate limiting middleware added to `indexer`, `prover`, and `relayer`.
6. Request-id propagation (`x-request-id`) and structured audit logs added for privileged actions.

Acceptance criteria:
1. Unauthenticated requests to `/internal/*` are rejected.
2. Replay and expired signatures are rejected.
3. Internal mutation APIs are not reachable from public internet.

---

### P0-4 Durable persistence and queue correctness

Status: In progress (queue correctness improved; durable DB still pending).

Current blockers:
- JSON-file storage for indexer and prover queue:
  - `/services/indexer/src/store.ts`
  - `/services/prover/src/server.ts`
- Prover dequeues before successful settle transaction confirmation.

Deliverables:
1. Replace JSON state with Postgres (or equivalent) using transactions.
2. Add outbox/inbox pattern for enqueue + settle updates.
3. Make settle worker idempotent with unique constraints:
   - `batch_id`
   - `intent_id`
   - `deposit_id`
4. Dequeue only after successful settlement receipt.
5. Add dead-letter queue and retry policy with backoff.

Implemented:
1. Prover queue no longer dequeues before successful settlement tx confirmation.
2. Prover batch cursor (`nextBatchId`) persisted to disk state file.
3. Prover enqueue deduplication added by action key.
4. Concurrent flush guard added to avoid overlapping settlement attempts.

Acceptance criteria:
1. Service restart does not lose in-flight actions.
2. Duplicate enqueue does not cause duplicate settlement.
3. Failed settlement leaves actions available for retry.

---

## Phase 1 (Security and Protocol Hardening)

### P1-1 Oracle production integration

Current state:
- Risk reads direct oracle interface, currently used with mocks.

Deliverables:
1. Integrate production price adapters with staleness checks and heartbeat bounds.
2. Add fallback oracle policy and circuit-breaker behavior.
3. Add tests for stale/zero/outlier prices.

Acceptance criteria:
1. Borrow/withdraw/lock operations reject stale prices.
2. Price outage triggers safe-mode behavior without unsafe credit expansion.

---

### P1-2 Governance and role separation

Deliverables:
1. Move contract ownership/admin roles to multisig + timelock.
2. Separate emergency pause roles from config-update roles.
3. Add role revocation and break-glass runbook.

Acceptance criteria:
1. No EOA is single point of failure for protocol-critical controls.
2. Timelock protects risk/config changes in production.

---

### P1-3 Relayer economics and risk controls

Current state:
- Static quote model in relayer (`30 bps`) with no inventory/risk engine.

Deliverables:
1. Dynamic quoting based on inventory, volatility, latency, and gas.
2. Per-asset and per-user relayer exposure limits.
3. Fill throttles and circuit breakers.

Acceptance criteria:
1. Relayer rejects fills outside configured risk envelope.
2. Quote service adapts to liquidity and gas conditions.

---

## Phase 2 (Operational Readiness)

### P2-1 Observability and SRE

Deliverables:
1. Metrics: queue depth, settlement latency, proof generation time, lock failures, fill failures.
2. Distributed tracing across relayer/indexer/prover.
3. Alerting for stuck queue, reorg anomalies, high failure rate.

Acceptance criteria:
1. On-call can detect and triage any failed/stalled lifecycle stage within minutes.

---

### P2-2 CI/CD and environment promotion

Deliverables:
1. Add testnet/mainnet deploy pipeline with explicit env validation.
2. Add pre-deploy simulation checks and post-deploy smoke tests.
3. Add rollback scripts and runbooks.

Acceptance criteria:
1. One-command deterministic deploy per environment.
2. Rollback can be executed within defined recovery target.

---

### P2-3 Security verification program

Deliverables:
1. Add Foundry invariant and fuzz suites for cross-chain lifecycle safety properties.
2. Commission external audit (contracts + critical services).
3. Resolve high/critical issues and publish security notes.

Acceptance criteria:
1. No unresolved high/critical findings before mainnet.

---

## Recommended Execution Order

1. P0-3 Internal API auth.
2. P0-4 Durable persistence and queue correctness.
3. P0-2 Canonical bridge attestation path.
4. P0-1 Real ZK proving pipeline.
5. P1-1 Oracle production integration.
6. P1-2 Governance hardening.
7. P1-3 Relayer risk engine.
8. P2-1/P2-2/P2-3 operational + audit closure.

This order reduces exploit surface early and avoids integrating real proving on top of weak service/data guarantees.
